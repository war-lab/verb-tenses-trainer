# Verb Tenses Trainer アーキテクチャ & 教育的指針

## 1. "Learning 1st" (学習第一) 原則
このアプリケーションは、単に正しい英語の文章を生成するだけでなく、時制やアスペクトの裏にある**ニュアンス**や**文脈**を教えることを目的として設計されています。

### 主な特徴:
- **時制・相マトリックス学習**: 時制や相を単なる切り替えスイッチとして扱うのではなく、**12セルのマトリックス（3つの時制 × 4つの相）**として扱います。すべての組み合わせには、独自のシチュエーション解説、自然な和訳、学習上のポイント（Why?）が含まれます。
- **繊細な未来表現の選択**: `will` は単一の概念ではありません。ユーザーは4つの異なるニュアンス（Decision:その場の決定, Offer:申し出, Promise:約束, Prediction:予測）から選択できます。これは、未来時制におけるマトリックスの「第3の次元」となります。
- **インタラクションの制約**:
  - `be going to` と `will` の使い分けを明確化。
  - `progFuture` (確定した予定) はデフォルトで進行形を強制しますが、文脈に応じて他の相との組み合わせもサポートします。
  - `aboutTo` (間近な未来) は、動作がまさに始まろうとしている瞬間に焦点を当てます。

### 哲学: "Context over Conjugation" (活用よりも文脈)
背景: 日本の英語教育の多くは、「公式的な」活用（例: `will` + 動詞の原形）に焦点を当てがちです。
目的: このアプリは、焦点を**文脈による選択**に移すことを目指しています。「未来完了形」を単なる文法公式としてではなく、「締め切りまでの完了」を表す手段として提示することで、学習者が英語の時間感覚に対するメンタルマップを構築できるよう支援します。

---

## 2. 技術設計 (Technical Design)

### データ層 (Tense-Aspect Matrix)
- **`src/data/sentences.ts`**: **階層的オーバーライド (Hierarchical Override)** パターンを使用して、12セルのマトリックスを実装しています。
  - `lesson`: グローバルなデフォルトメタデータ（通常は現在形・基本相）。
  - `tenseOverrides`: 時制レベルのオーバーライド（過去、未来）。
    - `aspectOverrides`: 時制内の**ネストされた**オーバーライド。これがマトリックスシステムの核心であり、「未来完了」が「現在完了」とは全く異なるシチュエーション解説を持つことを可能にします。
  - `willNuances` / `modeOverrides`: 未来表現の「第3の次元」のための詳細なオーバーライド。

### ロジック層 (優先順位付きマージ)
- **`src/lib/conjugator.ts`**: 12の組み合わせ + 未来表現モードの全マトリックスを処理する純粋関数エンジン。
- **`src/lib/rules.ts`**: 警告（例: 状態動詞の進行形使用など）を生成するバリデーション層。
- **`src/lib/lessonHelper.ts`**: `getEffectiveLessonMeta` 関数を実装。
  - **マージ優先順位**: Tense基本 -> Future Mode/Nuance -> Aspect Override。
  - この優先順位により、ユーザーが特定の相（完了形など）を選択した場合、その具体的な解説が一般的な時制/モードの解説よりも優先され、一般的な `will` の解説が具体的な「未来完了」の学習ポイントを隠してしまうのを防ぎます。

### トレーニングロジック (Learning 1st)
- **`src/training/generator.ts`**: 高品質なメタデータを持つ問題のみを生成します (**Quality Gate**)。また、未来表現のニュアンス（例: `will`予測 vs `goingTo`）において、「許容解 (Acceptable Answer)」をプログラム的に生成します。
- **`src/training/grader.ts`**: `ruleOfThumbJa`（判断の目安）を優先して表示し、即座にフィードバックを与えます。Diff Badges（差分バッジ）を計算し、どのパラメータ（時制/相/モード）が間違っていたかを正確に示します。
- **`src/training/scheduler.ts`**: 軽量な SRS (間隔反復システム)。
  - 間違い/許容: 短い間隔 (1分 / 3分)。
  - 正解 (Streak 1): **ショートレビュー (10分)** を挟み、短期記憶への定着を確認します。
  - 正解 (Streak 2以降): 指数関数的に間隔を広げます (4時間, 16時間...)。

### UI層
- **Radix UI**: `Sheet` (ボトムシート) などの複雑なコンポーネントに使用。
- **Framer Motion**: スムーズな状態遷移やハイライトアニメーションに使用。
- **Tailwind CSS**: インディゴを基調とした、ハイエンドなモバイルファーストデザイン。

---

## 3. 開発者向けメンテナンスガイド (Maintenance Notes)

### 新しい動詞の追加
1. `src/data/verbs.ts` に動詞の定義を追加します。
2. 原形、過去形、過去分詞形を定義します。
3. 状態動詞（例: *know*, *like*）の場合は `progressiveAllowed: false` を設定します。

### 新しい例文テンプレートの追加
1. `src/data/sentences.ts` に新しいオブジェクトを追加します。
2. **教育的要件**: すべてのテンプレートには以下を含める必要があります:
   - `jpLiteral`: 構造を反映した直訳（例: "私はりんごを食べる"）。
   - `jpNatural`: ネイティブスピーカーが実際に使う自然な日本語。
   - `whyJa`: なぜその形式が使われるのかの理由リスト。
3. **未来表現のニュアンス**: `willNuances` を使用して、`will` の文脈固有の解説（Decision, Offer, Promise, Prediction）を提供します。

### ロジックのオーバーライド
`SentenceTemplate` 内で `modeOverrides` または `willNuances` を使用して、デフォルトの `LessonMeta` を上書きします。これは、特定の時制が特定の文脈で特別な意味を持つ場合（例: 予定された会議に進行形を使う場合など）に有用です。

---

## 技術的負債とロードマップ
- [x] **Training Mode**: SRSと品質ゲートを備えた「学習第一」の実践モードを実装済み。
- [ ] **Quiz Mode**: 選択するまで英語の文章を隠すモードの実装。
- [ ] **Voice Synthesis**: Web Speech API を統合し、聴覚学習を可能にする。
- [ ] **Dark Mode Refinement**: `Tense` トグルのようなカスタムコントロールが、ダークモードでも高いコントラストを持つように改善する。
- **Usage Labels**: 概念を分類しやすくするための標準化されたバッジ（例: `[Perfect:Result]`）。
- **Split Compare**: 厳選された対比（例: 単純現在 vs 現在進行）を並べて比較表示する機能。
